---
title: "Metabolomics"
output: html_document
date: "2025-11-02"
---
```{r}
library(dplyr)
```

### "P01" follow up visit circa ~2015 on ~ 500 adolescents (includes 223 of the 250 seen in 2012)

#Reading in data
```{r}
data_ses<-read.csv("/Users/jackielindstrom/Documents/ELEMENT/P01_SES_201910.csv") # 
data_met<-read.csv("/Users/jackielindstrom/Documents/ELEMENT/P01_Metab_Named_Logscale_202002.csv") #2015 P01 on ~ 500 adolescents (includes 223 of the 250 seen in 2012)
data_sex_age<-read.csv("/Users/jackielindstrom/Documents/ELEMENT/P01_Sex_and_Age_202202.csv")
data_maturation<-read.csv("/Users/jackielindstrom/Documents/ELEMENT/P01_Sexual_Maturation_201910.csv")
data_metP20<-read.csv("/Users/jackielindstrom/Documents/ELEMENT/P20_Metabolites_QCadj_KNN5_20171204.csv") # 2011: Untargeted metabolomics from fasting blood & targeted on amino acids and acylcarnitines ... not used for this project!
dim(data_met)
```

# Check: Sex=2: female, Sex=1: male?
```{r}
head(data_sex_age)
```

# Pubertal onset not computed in data_maturation data frame yet. Code to calculated it below:
```{r}
#initiate binary puberty onset column
data_maturation$pub_onset<-NA
#pub_onset=0 if both P2_1 and P2_2 for female =1
data_maturation$pub_onset<-ifelse(data_maturation$p2_1==1 &  data_maturation$p2_2==1 & data_maturation$sexo==2, 0, data_maturation$pub_onset)

#pub_onset=0 if both P2_1 and P2_3 for male =1
data_maturation$pub_onset<-ifelse(data_maturation$p2_1==1 &  data_maturation$p2_3==1 & data_maturation$sexo==1, 0, data_maturation$pub_onset)

#pub_onset=1 if either P2_1 or P2 _2 for female is greater than 1
data_maturation$pub_onset<-ifelse((data_maturation$p2_1>1 |  data_maturation$p2_2>1) & data_maturation$sexo==2, 1, data_maturation$pub_onset)

#pub_onset=1 if either P2 _1 and P2_ 3 for male is greater than 1
data_maturation$pub_onset<-ifelse((data_maturation$p2_1>1 |  data_maturation$p2_3>1) & data_maturation$sexo==1, 1, data_maturation$pub_onset)

table(data_maturation$pub_onset)
```


# Make new data frames for each with just etapa = T1 visits
```{r}
data_ses_T1 <- data_ses[data_ses$etapa == "T1", ]
data_sex_age_T1 <- data_sex_age[data_sex_age$etapa == "T1", ]
data_mat_T1 <- data_maturation[data_maturation$etapa == "T1", ]
```

# Recode 13x6 SES into numerical, with A/B= 6 being the best SES
```{r}
data_ses_T1$amai_13x6num <- dplyr::recode(data_ses_T1$amai_13x6,
                      "A/B" = 6,
                      "C+" = 5,
                      "C" = 4,
                      "D+" = 3,
                      "D" = 2,
                      "E" = 1)
```

# Recode 8x7 SES into numerical, with A/B= 7 being the best SES
```{r}

data_ses_T1$amai_8x7num <- dplyr::recode(data_ses_T1$amai_8x7,
                      "A/B" = 7,
                      "C+"= 6,
                      "C" = 5,
                      "C-" = 4,
                      "D+" = 3,
                      "D" = 2,
                      "E" = 1)
```

```{r}
hist(data_ses_T1$amai_8x7num)
```

```{r}
hist(data_ses_T1$amai_13x6num)
```

# Merge variables of interest into one data frame (use "FOLIO"). Save to CSV "merged_data.csv"
```{r}
# left join keeps all rows in data_met, but will put NA if nothing in age/ses/sex
merged_data <- data_met %>%
  left_join(select(data_ses_T1, foliocc, amai_13x6num, amai_8x7num), c("FOLIOCC" = "foliocc")) %>%
  left_join(select(data_sex_age_T1, FOLIOCC, Age_P01, AC_sexH), by = "FOLIOCC") %>%
  left_join(select(data_mat_T1, foliocc, pub_onset), by = c("FOLIOCC" = "foliocc"))

write.csv(merged_data, "merged_data.csv", row.names = FALSE)
head(merged_data)
```


# Trying one linear regression with one metabolite
```{r}
fit1 <- lm(Keto_14_0_1 ~ amai_8x7num + Age_P01 + pub_onset + AC_sexH, data = merged_data)
summary(fit1)
```

```{r}
# Select just metabolite columns from merged data
metabolite_names <- setdiff(names(merged_data), c("FOLIOCC", "amai_13x6num", "amai_8x7num", "Age_P01", "pub_onset", "AC_sexH"))

# Linear regression for each metabolite
results_list <- lapply(metabolite_names, function(met){
  formula <- as.formula(paste(met, "~ amai_8x7num + Age_P01 + pub_onset + AC_sexH"))
  fit <- lm(formula, data = merged_data)
  summary(fit)$coefficients  # get the coeff table
})

# Name list with metabolite names
names(results_list) <- metabolite_names

# Ex: see results for metabolite 55
results_list[[55]]
metabolite_names[[5]]

# count how many have sig p values for SES
pvals_amai <- sapply(results_list, function(res){
  res["amai_8x7num", "Pr(>|t|)"]
})
betas_amai <- sapply(results_list, function(res){
  res["amai_8x7num", "Estimate"]
})
```

# Correct for FDR using benjamin- h
```{r}
FDR_amai <- p.adjust(pvals_amai, method = "BH")

all_results <- data.frame(
  metabolite = metabolite_names,
  beta =betas_amai,
  p.value = pvals_amai,
  FDR = FDR_amai
)
```


```{r}
sig_before_FDR <- subset(all_results, p.value < 0.05)
sig_before_FDR <- sig_before_FDR[order(sig_before_FDR$p.value), ]

print(sig_before_FDR)
write.csv(sig_before_FDR, "sig_before_FDR", row.names=FALSE)
```

```{r}
# FDR < 0.1
sig_FDR_10 <- subset(all_results, FDR < 0.1)
sig_FDR_10 <- sig_FDR_10[order(sig_FDR_10$FDR), ]

print(sig_FDR_10)
write.csv(sig_FDR_10, "sig_FDR_10.csv", row.names = FALSE)

# FDR < 0.2
sig_FDR_20 <- subset(all_results, FDR < 0.20)
sig_FDR_20 <- sig_FDR_20[order(sig_FDR_20$FDR), ]
print(sig_FDR_20)
```

# Making nicer table of post FDR results:


```{r}
library(rempsyc)
library(flextable)

df_results <- data.frame(
  metabolite = all_results$metabolite,
  beta       = all_results$beta,
  p.value    = all_results$p.value,
  FDR        = all_results$FDR
)

df_sub10 <- subset(df_results, FDR < 0.1)

ft <- nice_table(
  df_sub10,
  title = c("Table 1", "Metabolites Associated with SES (FDR < 0.10)"),
  note  = "Models adjusted for age, sex hormone, and pubertal onset."
)
ft
```


```{r}
df_sub20 <- subset(df_results, FDR < 0.2)
ft2 <- nice_table(
  df_sub20,
  title = c("Table 2", "Metabolites Associated with SES (FDR < 0.20)"),
  note  = "Models adjusted for age, sex hormone, and pubertal onset."
)

ft2 <- flextable::color(
  ft2,
  i = df_sub20$metabolite == "FA_13_0__DiC_",   
  j = "metabolite",                        
  color = "blue"                             
)

ft2

```


```{r}
df_sub25 <- subset(df_results, FDR < 0.25)
ft3 <- nice_table(
  df_sub25,
  title = c("Table 3", "Metabolites Associated with SES (FDR < 0.25)"),
  note  = "Models adjusted for age, sex hormone, and pubertal onset."
)

ft3
```
```{r}
df_sub30 <- subset(df_results, FDR < 0.30)
ft4 <- nice_table(
  df_sub30,
  title = c("Table 3", "Metabolites Associated with SES (FDR < 0.30)"),
  note  = "Models adjusted for age, sex hormone, and pubertal onset."
)

print(ft4)
```

```{r}
df_unadj <- subset(df_results, p.value < 0.05)

ft5 <- nice_table(
  df_unadj,
  title = c("Table 4", "Metabolites Associated with SES at uncorrected pvalue < 0.05"),
  note  = "Models adjusted for age, sex hormone, and pubertal onset."
)

print(ft5)
save_as_docx(ft5, path = "ft5_table.docx")

```


```{r}
data_met_nofolio <- data_met[, -1]
```

Changing all met data to quartiles
```{r}
met_data_ord <- as.data.frame(
  apply(data_met_nofolio, 2, function(x) {
    cut(x, breaks = quantile(x, probs = seq(0, 1, 0.25), na.rm = TRUE),
        include.lowest = TRUE, labels = FALSE)
  })
)
```


# Trying IRT with ALL Metabolites before looking at SES associations

```{r}
library(mirt)

fit_met <- mirt(data=met_data_ord, 1, itemtype = "graded")  #use "graded" bc responses are ordinal, not binary like in the class example
parms_met <- coef(fit_met, IRTpar = TRUE, simplify = TRUE) #also called loadings!

head(parms_met)
```
# tells me how difficult it is to get each outcome (1,2,3,4, concentration level depending on metaoblite)
```{r}
plot(fit_met, type="trace", facet=FALSE)
```

# shows the latent metabolic trait was measured w higest precision near the mean of theta=0, more reliable for average person?
```{r}
plot(fit_met, type = "info")
```

```{r}
plot(fit_met, type = "trace",  which.items = 1:10) 
```


Are these items performing similarly for high/ low ses?
```{r}
# first split SES into high / low... 
merged_data$amai_binary <- ifelse(
  merged_data$amai_8x7num >= median(merged_data$amai_8x7num, na.rm = TRUE),
  1, 
  0
)
table(merged_data$amai_binary)
```

Are these items performing similarly for high and low SES?
Error in probgrm(theta, DISC[i], CB[i, ]) : slope is missing or negative
```{r}
dif_met <- lordif(met_data_ord, merged_data$amai_binary)
```

trying something else
```{r}
DIF_results <- DIF(fit_met, which.par = c("a1", "d"), covariates = merged_data$amai_binary)
summary(DIF_results)

```


```{r}
theta <- fscores(fit_attempt)
merged_data$IRT_met_score <- theta
```


```{r}
summary(lm(IRT_met_score ~ amai_8x7num + Age_P01 + AC_sexH + pub_onset,
           data = merged_data))
```

# IRT but with metabolites identified as being sig associated with SES using df_unadj
```{r}
head(df_unadj)
```

```{r}
library(ggplot2)

names_met_unadj<-df_unadj$metabolite

metab_matrix <- merged_data[, colnames(merged_data) %in% names_met_unadj]


metab_ord <- as.data.frame(
  apply(metab_matrix, 2, function(x) {
    cut(x, breaks = quantile(x, probs = seq(0, 1, 0.25), na.rm = TRUE),
        include.lowest = TRUE, labels = FALSE)
  })
)
fit_ord <- mirt(metab_ord, 1, itemtype = "graded")

theta1 <- fscores(fit_ord)
head(theta1)
```
```{r}
parms_latent <- coef(fit_ord, IRTpars = TRUE, simplify = TRUE)$items
parms_latent
```


# 2 latent traits?
```{r}
fit2 <- mirt(metab_ord, 2, itemtype = "graded")
theta2 <- fscores(fit2)
```
```{r}
head(theta2)
```
```{r}
parms_latent2<-coef(fit2, IRTpars = TRUE, simplify = TRUE)$items
parms_latent2
```


# Pearsons correlation heatmap... not sure it shows there are a lot of correlations... 
```{r}

metab_matrix <- merged_data[, colnames(merged_data) %in% names_met_unadj]

cor_mat <- cor(metab_matrix, use = "pairwise.complete.obs", method = "pearson")

png("heatmap.png", width = 1200, height = 1200, res = 150)
heatmap(cor_mat, 
        main = "Pearson Correlations: 27 Metabolites, Unadjusted for FDR",
        col = colorRampPalette(c("lightblue", "white", "red"))(100),
        margins = c(15,15))
dev.off()

```


